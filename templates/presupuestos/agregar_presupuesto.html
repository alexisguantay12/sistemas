{% extends 'base2.html' %}
{% load static %}
{% block content %}


<style>
:root{
    /* Par√°metros para ajustar compactaci√≥n r√°pidamente */
    --input-padding: 0.28rem;        /* cambiar -> menor = m√°s compacto */
    --font-size-base: 0.88rem;      /* tama√±o base de la UI */
    --table-font-size: 0.70rem;     /* tama√±o de la tabla */
    --card-padding: 0.55rem;        /* padding interior de las cards */
    --card-radius: 8px;
}

/*  AJUSTES R√ÅPIDOS (cambia aqu√≠ para m√°s/menos compacto)
   - --input-padding: reduce para hacerlo m√°s compacto
   - --font-size-base: tama√±o base de letra
   - --table-font-size: fuente en tabla (reduce para que entre m√°s)
   - TAX_RATE: variable JS (ver m√°s abajo)
   ========================= */

/* Compactar las cards */
.card {
    border: none;
    border-radius: var(--card-radius);
    margin-bottom: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    padding: var(--card-padding);
    font-size: var(--font-size-base);
}

/* T√≠tulos m√°s discretos */
.card-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.45rem;
}

/* Inputs compactos */
.form-control, .form-select {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: var(--input-padding) 0.5rem;
    font-size: 0.76rem;
    background-color: #fff;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
    transition: all 0.15s ease-in-out;
    height: 25px; /* bajar si quer√©s m√°s compacto */
}


.form-control:focus, .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 4px rgba(0,123,255,0.18);
}

/* Etiquetas m√°s peque√±as */
label {
    font-size: 0.79rem;
    color: #191b1c;
    margin-bottom: 2px;
    display: block;
}

/* Tabla ultra compacta */
.table {
    font-size: var(--table-font-size);
    margin-bottom: 0;
}

.table td, .table th {
    padding: 0.28rem;
    vertical-align: middle;
    white-space: nowrap;
}

/* Botones m√°s sutiles */
.btn-sm {
    padding: 0.18rem 0.45rem;
    border-radius: 6px;
    font-size: 0.78rem;
}

/* Totales m√°s prolijos */
.card-body.text-end p, 
.card-body.text-end h5 {
    margin: 0.12rem 0;
    font-size: 0.9rem;
}

/* Para forzar que la vista ocupe m√°s ancho en pantallas grandes */
.container.my-4 {
    max-width: 1200px;
}

/* Iconos de acci√≥n peque√±os */
.btn-danger.btn-sm, .btn-success.btn-sm {
    line-height: 1;
    height: 30px;
}

/* Alinear inputs a la derecha */
#tabla-prestaciones input.precio,
#tabla-prestaciones input.importe,
#tabla-prestaciones input.iva,
#tabla-prestaciones input.subtotal {
    text-align: right;
}







.input-group-sm > .form-control,
.input-group-sm > .btn {
    height: 24px; /* asegura que coincida con los dem√°s */
}

td {
    vertical-align: middle !important;
}
.lupa-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;            /* elimina relleno interno extra */
  width: 38px;           /* igual ancho que alto */
  height: 38px;          /* mismo alto que el input */
}

.lupa-btn i {
  font-size: 14px;       /* ajusta tama√±o del √≠cono */
  margin: 0;             /* sin desplazamiento */
}

</style>

<div class="container my-4">
    <h3 class="text-primary"><i class="fas fa-file-medical"></i> Nuevo Presupuesto</h3>
    <form method="POST" id="form-presupuesto" autocomplete="off">
        {% csrf_token %} 
        <!-- Datos del paciente -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title">Datos del Paciente</h5>
                <div class="row g-2">
                    <!-- Ajust√° las clases col-md-* para controlar cu√°ntas columnas entran -->
                    <div class="col-md-4">
                        <label>Nombre</label>
                        <input type="text" name="paciente_nombre" class="form-control" required autocomplete="off">
                    </div>
                    <div class="col-md-2">
                        <label>DNI</label>
                        <input type="text" name="paciente_dni" class="form-control" autocomplete="off" required="true">
                    </div>
                    <div class="col-md-2">
                        <label>Edad</label>
                        <input type="number" name="paciente_edad" class="form-control" autocomplete="off">
                    </div>
                    
                    <div class="col-md-4">
                        <label><span>Direcci√≥n</span>
                        </label>
                        <input type="text" name="paciente_di" class="form-control" autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <label>Tel√©fono</label>
                        <input type="text" name="paciente_telefono" class="form-control" autocomplete="new-password">
                    </div>
                    <div class="col-md-3">
                        <label>Email</label>
                        <input type="text" name="paciente_email" class="form-control" autocomplete="new-password">
                    </div>
                    <div class="col-md-3">
                        <label>Obra Social</label>
                        <input type="text" name="obra_social" class="form-control" autocomplete="off">
                    </div>
                </div>
            </div> 
            <div class="card-body">
                <h5 class="card-title">Datos M√©dicos</h5>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label>M√©dico</label>
                        <input type="text" name="medico" class="form-control" autocomplete="off">
                    </div>
                    <div class="col-md-6">
                        <label>Diagn√≥stico</label>
                        <input type="text" name="diagnostico" class="form-control" autocomplete="off">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de prestaciones -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Prestaciones

                    <!-- Controles extras -->
                    <div class="d-flex align-items-center gap-3">
                        <!-- Checkbox IVA -->
                        <label class="form-check-label" for="chk-iva">IVA</label>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="chek-iva" checked>
                        </div>

                        <!-- Proporcional Medicamentos -->
                        <div class="d-flex align-items-center">
                            <label for="med-prop" class="me-1 mb-0">Prop. Medicamentos</label>
                            <select id="med-prop" class="form-select form-select-sm" style="width: 80px;">
                                <option value="40">40%</option>
                                <option value="45">45%</option>
                                <option value="50" selected>50%</option>
                                <option value="55">55%</option>
                                <option value="60">60%</option>
                            </select>
                        </div>

                        <!-- Bot√≥n Medicamentos -->
                        <button type="button" id="btn-medicamentos" class="btn btn-info btn-sm">
                            <i class="fas fa-pills"></i> Agregar Prop Medicamentos
                        </button>
                    </div>
                </h5>

                <div class="table-responsive mt-2">
                    <table class="table table-bordered align-middle" id="tabla-prestaciones">
                        <thead class="table-light">
                            <tr>
                                <th style="width:90px">C√≥digo</th>
                                <th style="width:70px">Tipo</th>
                                <th style="width:240px">Prestaci√≥n</th> 
                                <th style="width:50px">Cant.</th>
                                <th style="width:100px">Precio U.</th>
                                <th style="width:100px">Importe</th>
                                <th style="width:100px">IVA</th>
                                <th style="width:100px">Total</th>
                                <th style="width:45px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="fila-detalle">
                                <td >
                                    <div class="input-group input-group-sm">
                                        <input type="text" name="codigo" class="form-control codigo" autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary lupa-btn" data-bs-toggle="modal" data-bs-target="#modalBusqueda">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </td> 
                                <td>
                                    <select name="tipo" class="form-control tipo">
                                        <option value="gastos" selected>Gastos</option>
                                        <option value="especialista">Especialista</option>
                                        <option value="todo">Todo</option>
                                    </select>
                                </td>
                                <td><input type="text" name="prestacion" class="form-control prestacion"></td>
                                <td><input type="number" name="cantidad" class="form-control cantidad" value="1" min="1"></td>
                                <td><input type="number" name="precio" class="form-control precio" step="0.01" value="0.00"></td>
                                <td><input type="text" name="importe" class="form-control importe" readonly value="0.00"></td>
                                <td><input type="text" name="iva" class="form-control iva" readonly value="0.00"></td>
                                <td><input type="text" name="subtotal" class="form-control subtotal" readonly value="0.00"></td>
                                <td><button type="button" class="btn btn-danger btn-sm eliminar-fila">X</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="mt-2 col-md-6">
                        <button type="button" id="agregar-fila" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Agregar Prestaci√≥n</button>
                    </div>
                    <div class="card-body text-end mt-0 col-md-6">
                        <p><strong>Importe sin iva:</strong> $<span id="subtotal">0.00</span></p>
                        <p><strong>IVA (21%):</strong> $<span id="iva">0.00</span></p>
                        <h5><strong>Total:</strong> $<span id="total">0.00</span></h5>
                    </div>
                </div>
            </div>
        </div> 

        <div class="text-end">
        <button type="button" class="btn btn-primary" id="btnGuardarPresupuesto">
            <i class="fas fa-save"></i> Guardar Presupuesto
        </button>
        </div>


        
        <!-- Modal Buscador -->
        <div class="modal fade" id="modalBusqueda" tabindex="-1" aria-labelledby="modalBusquedaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="modalBusquedaLabel">Buscar Nomenclador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="input-group mb-3">
                <input type="text" id="busqueda" class="form-control" placeholder="Buscar por c√≥digo o nombre...">
                <button type="button" class="btn btn-primary" id="btnBuscar">Buscar</button>
                </div>

                <table class="table table-hover table-sm" id="tablaResultados">
                <thead>
                    <tr>
                    <th>C√≥digo</th>
                    <th>Nombre</th>
                    <th>Gastos</th>
                    <th>Especialista</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llena din√°micamente -->
                </tbody>
                </table>
            </div>
            </div>
        </div>
        </div>


        <!-- Modal de Confirmaci√≥n --> 
        <div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-sm">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title" id="modalConfirmacionLabel">
                    <i class="fas fa-save me-2"></i> Confirmar guardado
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">¬øDese√°s guardar este presupuesto?</p>
                    <small class="text-muted">Podr√°s editarlo m√°s adelante si es necesario.</small>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnConfirmarGuardar">
                    <i class="fas fa-check"></i> Guardar
                    </button>
                </div>
                </div>
            </div>
        </div>

    </form>
</div>

<script>
/*
  Par√°metros JS que pod√©s cambiar
  - TAX_RATE: tasa de IVA (ej: 0.21)
  - DECIMALS: cantidad de decimales que quer√©s mostrar
*/
const TAX_RATE = 0.21;
const DECIMALS = 2;

/* Actualiza una fila dada (calcula importe, iva y total fila) */
function actualizarFila(tr){
    const precioEl = tr.querySelector(".precio");
    const cantidadEl = tr.querySelector(".cantidad");
    const importeEl = tr.querySelector(".importe");
    const ivaEl = tr.querySelector(".iva");
    const subtotalEl = tr.querySelector(".subtotal");

    const precio = parseFloat(precioEl.value) || 0;
    const cantidad = parseFloat(cantidadEl.value) || 0;

    const importe = precio * cantidad;               // sin IVA
    const iva = importe * TAX_RATE;                 // IVA por fila
    const total = importe + iva;                    // total por fila

    importeEl.value = importe.toFixed(DECIMALS);
    ivaEl.value = iva.toFixed(DECIMALS);
    subtotalEl.value = total.toFixed(DECIMALS);
}


let filaActualBuscador = null;

// 1Ô∏è‚É£ Cuando se hace clic en la lupa, guardamos qu√© fila lo llam√≥
document.addEventListener('click', function(e) {
    if (e.target.closest('.lupa-btn')) {
        filaActualBuscador = e.target.closest('tr');
    }
});

// 2Ô∏è‚É£ Simulaci√≥n de datos (en tu caso se traer√°n de Django por fetch)
const urlBuscarNomenclador = "{% url 'presupuestos_app:buscar_nomenclador' %}";
 
// 2Ô∏è‚É£ Buscar en el backend
document.getElementById('btnBuscar').addEventListener('click', () => {
    const termino = document.getElementById('busqueda').value.trim();

    if (!termino) {
        alert("Por favor ingresa un t√©rmino de b√∫squeda.");
        return;
    }

    fetch(`${urlBuscarNomenclador}?q=${encodeURIComponent(termino)}`)
        .then(response => {
            if (!response.ok) throw new Error("Error al buscar en el servidor");
            return response.json();
        })
        .then(resultados => {
            const tbody = document.querySelector('#tablaResultados tbody');
            tbody.innerHTML = '';

            if (resultados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Sin resultados</td></tr>';
                return;
            }

            resultados.forEach(item => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${item.codigo}</td>
                    <td>${item.nombre}</td>
                    <td>${item.gastos}</td>
                    <td>${item.especialista}</td>
                `;
                fila.style.cursor = 'pointer';
                fila.addEventListener('click', () => seleccionarItem(item));
                tbody.appendChild(fila);
            });
        })
        .catch(error => {
            console.error(error);
            alert("Ocurri√≥ un error al buscar los datos.");
        });
});

// 4Ô∏è‚É£ Cuando se selecciona un √≠tem, se completa la fila y se cierra el modal

// 2Ô∏è‚É£ Seleccionar √≠tem del modal y completar la fila
async function seleccionarItem(item) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalBusqueda'));
    modal.hide();

    if (!filaActualBuscador) return;

    const fila = filaActualBuscador;
    const codigo = item.codigo;

    fila.querySelector('.codigo').value = codigo;

    try {
        // ‚öôÔ∏è Consultar al backend con el c√≥digo seleccionado
        const url = "{% url 'presupuestos_app:get_prestacion' codigo='__codigo__' %}".replace("__codigo__", encodeURIComponent(codigo));

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Error en la respuesta del servidor");

        const data = await resp.json();

        // ‚úÖ Completar los campos
        fila.querySelector(".tipo").value = "gastos";
        fila.querySelector(".prestacion").value = data.nombre || "";
        fila.querySelector(".precio").value = (parseFloat(data.precio) || 0).toFixed(DECIMALS);

        // Forzar cantidad = 1 si estaba vac√≠a
        if (!fila.querySelector(".cantidad").value) fila.querySelector(".cantidad").value = 1;

        // Recalcular totales
        actualizarFila(fila);
        calcularTotales();

    } catch (err) {
        console.error("Error:", err);
        alert("No se encontr√≥ la prestaci√≥n para el c√≥digo " + codigo);
    }
}



 
 

/* Aca esta funcion agrega proporcionales en medicamento */
document.getElementById("btn-medicamentos").addEventListener("click", function() {
    const porcentaje = parseFloat(document.getElementById("med-prop").value) / 100; // 0.4, 0.5, etc.
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;

    // Funci√≥n auxiliar para procesar un c√≥digo base y crear/actualizar fila proporcional
    function procesarCodigoBase(codigoBase, codigoDestino, nombrePrestacion) {
        // Buscar fila existente (la proporcional)
        let filaExistente = Array.from(tbody.querySelectorAll("tr"))
            .find(f => f.querySelector(".codigo").value.trim() === codigoDestino);

        // Sumamos cantidades y precios proporcionales de todas las filas con codigoBase
        let totalCantidad = 0;
        let totalPrecio = 0;

        Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
            const codigo = fila.querySelector(".codigo").value.trim();
            if (codigo === codigoBase) {
                const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
                const precioOriginal = parseFloat(fila.querySelector(".precio").value) || 0;
                totalCantidad += cantidad;
                totalPrecio += precioOriginal * porcentaje * cantidad;
            }
        });

        if (totalCantidad === 0) return; // no hay filas base, nada que hacer

        const iva = ivaIncluido ? totalPrecio * TAX_RATE : 0;
        const subtotal = totalPrecio + iva;

        if (!filaExistente) {
            // Creamos nueva fila basada en la primera fila del codigoBase
            const filaBase = Array.from(tbody.querySelectorAll("tr"))
                .find(f => f.querySelector(".codigo").value.trim() === codigoBase);

            if (!filaBase) return; // seguridad por si no se encuentra

            const nuevaFila = filaBase.cloneNode(true);

            // Seteamos valores proporcionales
            nuevaFila.querySelector(".codigo").value = codigoDestino;
            nuevaFila.querySelector(".prestacion").value = nombrePrestacion;
            nuevaFila.querySelector(".cantidad").value = totalCantidad;
            nuevaFila.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS);
            nuevaFila.querySelector(".importe").value = totalPrecio.toFixed(DECIMALS);
            nuevaFila.querySelector(".iva").value = iva.toFixed(DECIMALS);
            nuevaFila.querySelector(".subtotal").value = subtotal.toFixed(DECIMALS);

            // Insertamos al final
            tbody.appendChild(nuevaFila);
        } else {
            // Actualizamos fila existente
            filaExistente.querySelector(".cantidad").value = totalCantidad;
            filaExistente.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS);
            filaExistente.querySelector(".importe").value = totalPrecio.toFixed(DECIMALS);
            filaExistente.querySelector(".iva").value = iva.toFixed(DECIMALS);
            filaExistente.querySelector(".subtotal").value = subtotal.toFixed(DECIMALS);
        }
    }

    // --- Procesamos c√≥digos fijos ---
    procesarCodigoBase("430101", "medint", "Medicamentos y descartables en Internado");
    procesarCodigoBase("400101", "meduti", "Medicamentos y descartables en UTI");

    // --- Nueva l√≥gica para generar MEDQUIR ---
    Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
        const codigo = fila.querySelector(".codigo").value.trim();

        // Si es un c√≥digo num√©rico y cumple la condici√≥n (<140000 o >720000)
        if (!isNaN(codigo) && (parseInt(codigo) < 140000 || parseInt(codigo) > 720000)) {
            procesarCodigoBase(codigo, "medquir", "Medicamentos y descartables en Quir√≥fano");
        }
    });

    // Recalculamos totales generales
    calcularTotales();
});
 /* Recalcula totales generales */
function calcularTotales() {
    let subtotal = 0;
    let ivaTotal = 0;
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;
    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => {
        const cantidad = parseFloat(tr.querySelector(".cantidad")?.value) || 0;
        const precio = parseFloat(tr.querySelector(".precio")?.value) || 0;

        const importe = cantidad * precio;
        let iva = ivaIncluido ? importe * TAX_RATE : 0;

        const totalFila = importe + iva;

        // Actualizamos fila
        tr.querySelector(".importe").value = importe.toFixed(DECIMALS);
        tr.querySelector(".iva").value = iva.toFixed(DECIMALS);
        tr.querySelector(".subtotal").value = totalFila.toFixed(DECIMALS);

        subtotal += importe;
        ivaTotal += iva;
    });

    // Control del checkbox IVA
   
    if (!ivaIncluido) ivaTotal = 0;

    const total = subtotal + ivaTotal;

    // Actualizamos pantalla
    document.getElementById("subtotal").textContent = subtotal.toFixed(DECIMALS);
    document.getElementById("iva").textContent = ivaTotal.toFixed(DECIMALS);
    document.getElementById("total").textContent = total.toFixed(DECIMALS);
}

/* Delegaci√≥n de eventos: input y cambios en la tabla */
document.addEventListener("input", function(e){
    const tr = e.target.closest("tr");
    if (!tr || !tr.closest("#tabla-prestaciones")) return;

    // Si cambiaron precio o cantidad o si hay campos editables, recalcular fila
    if (e.target.classList.contains("precio") || e.target.classList.contains("cantidad") || e.target.classList.contains("codigo") || e.target.classList.contains("prestacion")){
        actualizarFila(tr);
        calcularTotales();
    }
});

/* Listener para cuando se pierde foco en campo 'codigo' -> busca prestaci√≥n v√≠a fetch */
document.getElementById("tabla-prestaciones").addEventListener("blur", async function(e) {
    if (e.target && e.target.classList.contains("codigo")){
        let codigo = e.target.value.trim();
        if (codigo !== "") {
            let fila = e.target.closest("tr");
            
            try {
                // Ajust√° la URL si tu named URL es diferente
                const url = "{% url 'presupuestos_app:get_prestacion' codigo='__codigo__' %}".replace("__codigo__", encodeURIComponent(codigo));

                let resp = await fetch(url);
                if (!resp.ok) throw new Error("Error en la respuesta del servidor");

                let data = await resp.json();
                // Esperamos que la respuesta JSON tenga { nombre, precio }
                fila.querySelector(".tipo").value="gastos"; 
                fila.querySelector(".prestacion").value = data.nombre || fila.querySelector(".prestacion").value;
                fila.querySelector(".precio").value = (parseFloat(data.precio) || 0).toFixed(DECIMALS);
                // forzamos cantidad a 1 si estaba vac√≠o
                if (!fila.querySelector(".cantidad").value) fila.querySelector(".cantidad").value = 1;

                // recalcular
                actualizarFila(fila);
                calcularTotales();
            } catch (err) {
                console.error("Error:", err);
                // no hacemos un alert intrusivo; pod√©s activar si quer√©s:
                // alert("No se encontr√≥ la prestaci√≥n para el c√≥digo " + codigo);
            }
        }
    }
}, true); // useCapture true para capturar blur en inputs
 

/* Listener para cuando se cambie el tipo de gasto */
document.querySelectorAll("#tabla-prestaciones").forEach((tabla) => {
    tabla.addEventListener("change", function (e) {
        if (e.target && e.target.classList.contains("tipo")) {
            let fila = e.target.closest("tr");
            let tipo = e.target.value;
            let codigo = fila.querySelector(".codigo").value;  // üëà tomo el c√≥digo de esa fila

            // construyo la URL din√°mica con Django
            const url = "{% url 'presupuestos_app:get_tipo' codigo='__codigo__' %}"
                            .replace("__codigo__", encodeURIComponent(codigo));

            fetch(`${url}?tipo=${tipo}`)
                .then((response) => response.json())
                .then((data) => {
                    let cantidad = parseFloat(fila.querySelector(".cantidad").value) || 1;
                    let precio = parseFloat(data.precio);
                    let iva = parseFloat(data.precio)*0.21;
                    let total = precio + iva;

                    // Impactamos en los campos
                    fila.querySelector(".precio").value = precio.toFixed(2);
                    fila.querySelector(".importe").value = (precio * cantidad).toFixed(2);
                    fila.querySelector(".iva").value = (iva * cantidad).toFixed(2);
                    fila.querySelector(".subtotal").value = (total * cantidad).toFixed(2);
                })
                .catch((error) => {
                    console.error("Error al traer datos:", error);
                });
        }
    });
});


/* Agregar fila - clonamos la primera fila y reseteamos valores */
document.getElementById("agregar-fila").addEventListener("click", function(){
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const template = tbody.querySelector("tr.fila-detalle");
    const fila = template.cloneNode(true);

    // resetear inputs
    fila.querySelectorAll("input").forEach(el => {
        if (el.classList.contains("cantidad")) el.value = 1;
        else if (el.classList.contains("precio")) el.value = (0).toFixed(DECIMALS);
        else el.value = "";
    });

    // recalcular fila reci√©n agregada
    actualizarFila(fila);
    tbody.appendChild(fila);
    calcularTotales();
});

/* Eliminar fila (delegado) */
document.addEventListener("click", function(e){
    if (e.target.classList.contains("eliminar-fila")){
        // Evita borrar la √∫ltima fila si quer√©s (opcional)
        const tbody = document.querySelector("#tabla-prestaciones tbody");
        if (tbody.querySelectorAll("tr").length === 1) {
            // si no quer√©s permitir eliminar la √∫ltima fila, limpiarla en su lugar:
            const tr = e.target.closest("tr");
            tr.querySelectorAll("input").forEach(i => i.value = (i.classList.contains("cantidad") ? 1 : ""));
        } else {
            e.target.closest("tr").remove();
        }
        calcularTotales();
    }
});

/* Inicializaci√≥n: recalcula en caso que haya valores precargados */
document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => actualizarFila(tr));
    calcularTotales();
    document.getElementById("chek-iva").addEventListener("change", calcularTotales);

   
});

/* --- Confirmaci√≥n antes de guardar --- */
document.getElementById("btnGuardarPresupuesto").addEventListener("click", function() {
    const modal = new bootstrap.Modal(document.getElementById("modalConfirmacion"));
    modal.show();
});

document.getElementById("btnConfirmarGuardar").addEventListener("click", function() {
    // Cierra el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById("modalConfirmacion"));
    modal.hide();

    // Env√≠a el formulario real
    document.getElementById("form-presupuesto").submit();
});


</script>

{% endblock %}
