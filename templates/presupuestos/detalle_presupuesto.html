{% extends 'base2.html' %}
{% load static %}
{% load group_tags %}
{% block content %}
<style>
:root {
    --input-padding: 0.28rem;
    --font-size-base: 0.88rem;
    --table-font-size: 0.70rem;
    --card-padding: 0.55rem;
    --card-radius: 8px;
}

.card {
    border: none;
    border-radius: var(--card-radius);
    margin-bottom: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    padding: var(--card-padding);
    font-size: var(--font-size-base);
}

.card-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.45rem;
}

.table {
    font-size: var(--table-font-size);
    margin-bottom: 0;
}

.table td, .table th {
    padding: 0.28rem;
    vertical-align: middle;
    white-space: nowrap;
}  
#miTabla td:nth-child(5),
#miTabla td:nth-child(6),
#miTabla td:nth-child(7),
#miTabla td:nth-child(8),
#miTabla th:nth-child(5),
#miTabla th:nth-child(6),
#miTabla th:nth-child(7),
#miTabla th:nth-child(8) {
    text-align: right;
}



/* === ESTILOS DE ESTADO (versión compacta) === */
.estado-badge {
    display: inline-block;
    padding: 2px 8px;              /* menos padding = más compacto */
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.60rem;            /* letra más chica */
    text-transform: uppercase;
    letter-spacing: 0.4px;
    color: #fff;
    transition: all 0.3s ease;
    line-height: 1.2;
}

/* Colores específicos */
.estado-pendiente {
    background-color: #ffc107;  /* amarillo */
    color: #000;
}

.estado-autorizado {
    background-color: #0d6efd;  /* azul */
}

.estado-en_curso {
    background-color: #28a745;  /* verde */
}

.estado-cerrado {
    background-color: #6f42c1;  /* morado */
}

.estado-expirado {
    background-color: #6c757d;  /* gris */
}







</style>

<div class="container my-4">
       <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <!-- Izquierda -->
        <div class="d-flex align-items-center gap-2">
            
            <h3 class="text-primary mb-0">
                <i class="fas fa-file-medical me-1"></i> Presupuesto N°{{ presupuesto.id }}
            </h3>

        </div>

        <!-- Derecha -->
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'presupuestos_app:presupuestos' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Volver al listado
            </a>
            {% if presupuesto.estado != 'expirado' %} 
                {% if presupuesto.estado == 'en_curso' %}
                <a href="#modalCerrar" class="btn btn-danger btn-sm" data-bs-toggle="modal">
                    <i class="fas fa-lock"></i> Cerrar
                </a>
                {% endif %}
                {% if presupuesto.estado == 'pendiente' and request.user|is_in_group:"administrador" %}
                    <a href="#modalAutorizar" class="btn btn-info btn-sm" data-bs-toggle="modal">
                        <i class="fas fa-cash-register"></i> Autorizar
                    </a>
                {% endif %}
                {% if presupuesto.estado != 'pendiente' %}
                    <a href="{% url 'presupuestos_app:imprimir_presupuesto' presupuesto.id %}" class="btn btn-info btn-sm">
                        <i class="fas fa-print"></i> Imprimir
                    </a>
                {% endif %}
                {% if presupuesto.estado != 'cerrado' %}
                    <a href="{% url 'presupuestos_app:editar_presupuesto' presupuesto.id %}" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                {% endif %}
                {% if presupuesto.estado != 'pendiente' %}
                    <a href="#modalPago" class="btn btn-success btn-sm" data-bs-toggle="modal">
                        <i class="fas fa-cash-register"></i> Pagos
                    </a> 
                {% endif %} 
                <a href="#modalHistorial" class="btn btn-info btn-sm" data-bs-toggle="modal">
                    <i class="fas fa-history"></i> Ver historial
                </a>
            {% endif %}
        </div>
    </div>


    <!-- Datos del paciente -->
    <div class="card shadow-sm mb-2">
        <div class="card-body">
            <h5 class="card-title">Datos del Paciente</h5>
            <div class="row g-2">
                <div class="col-md-4"><strong>Nombre:</strong> {{ presupuesto.paciente_nombre }}</div>
                <div class="col-md-3"><strong>DNI:</strong> {{ presupuesto.paciente_dni }}</div>
                <div class="col-md-2"><strong>Edad:</strong> {{ presupuesto.paciente_edad }}</div>
                <div class="col-md-4"><strong>Dirección:</strong> {{ presupuesto.paciente_direccion }}</div>
                <div class="col-md-3"><strong>Teléfono:</strong> {{ presupuesto.paciente_telefono }}</div>
                <div class="col-md-3"><strong>Email:</strong> {{ presupuesto.paciente_email }}</div>
                <div class="col-md-6"><strong>Obra Social:</strong> {{ presupuesto.obra_social  }}</div>
            </div>
        </div>
        <div class="card-body">
            <h5 class="card-title">Datos Adicionales</h5>
            <div class="row g-2">
                <div class="col-md-6"><strong>Médico:</strong> {{ presupuesto.medico }}</div>
                <div class="col-md-6"><strong>Diagnóstico:</strong> {{ presupuesto.diagnostico }}</div>
                <div class="col-md-6"><strong>Observaciones:</strong> {{ presupuesto.motivo_no_concretado }}</div>
                <div class="col-md-6">
                    <strong>Saldo:</strong> 
                    <span class="badge bg-secondary fs-8" id="saldo-detalle">
                        ${{ saldo|moneda_ar }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de prestaciones -->
    <div class="card shadow-sm mb-2">
        <div class="card-body">
            <h5 class="card-title">Prestaciones</h5>
            <div class="table-responsive mt-2">
                <table id="miTabla" class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Tipo</th>
                            <th>Prestación</th>
                            <th>Cant.</th>
                            <th>Precio U.</th>
                            <th>Importe</th>
                            <th>IVA</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in itemspresupuesto %}
                        <tr>
                            <td>{{ item.codigo }}</td>
                            <td>{{ item.get_tipo_display }}</td>
                            <td>{{ item.prestacion }}</td>
                            <td>{{ item.cantidad }}</td>
                            <td>${{ item.precio|floatformat:2|moneda_ar }}</td>
                            <td>${{ item.importe|floatformat:2|moneda_ar }}</td>
                            <td>${{ item.iva|floatformat:2|moneda_ar  }}</td>
                            <td>${{ item.subtotal|floatformat:2 |moneda_ar }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div> 
        <div class="card-body d-flex justify-content-between align-items-start">
            <div class="mt-3">
                <h6 class="mb-1">Seguimiento</h6>
                <div class="small">
                    <div><strong>Estado:</strong> <span id="estado-presupuesto" class="estado-badge estado-{{ presupuesto.estado }}">{{ presupuesto.get_estado_display }}</span></div>
                    <div><strong>Creado:</strong> {{ presupuesto.fecha_creacion|date:"d/m/Y H:i" }} por <strong> {{ presupuesto.user_made.first_name }} {{ presupuesto.user_made.last_name }}</strong></div>
                    <div><strong>Actualizado:</strong> {{ presupuesto.updated_at|date:"d/m/Y H:i" }} por<strong>{{ presupuesto.user_updated.first_name }} {{ presupuesto.user_updated.last_name }}</strong></div>
                </div>
            </div>
             <div class="mt-3">
            <div class="text-end">
                <div><strong>Total sin iva:</strong> ${{ presupuesto.subtotal|floatformat:2|moneda_ar  }}</div>
                <div><strong>Iva(21%):</strong> ${{ presupuesto.iva|floatformat:2|moneda_ar  }}</div>
                <div><strong>Total:</strong> ${{ presupuesto.total|floatformat:2|moneda_ar  }}</div>
            </div>
            </div>
        </div>
    </div>

    <!-- Modal Registro de Pago -->
    <div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="modalPagoLabel">Registro de Pago - Presupuesto Nro:{{ presupuesto.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Formulario de nuevo pago -->
                     {%if presupuesto.estado != 'cerrado'%}
                    <form id="formRegistroPago" method="post" action="{% url 'presupuestos_app:registrar_pago' presupuesto.id %}">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Monto</label>
                            <input type="number" step="0.01" class="form-control" name="monto" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Medio de Pago</label>
                            <select name="medio_pago" class="form-select" required>
                                <option value="efectivo">Efectivo</option>
                                <option value="cajab">Caja B</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="tarjeta_debito">Tarjeta Debito</option>
                                <option value="tarjeta_credito">Tarjeta Credito</option> 
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Comentario</label> 
                            <input type="text" class="form-control" name="observacion_pago">
                        </div>
                    </div>

                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-success">Guardar Pago</button>
                    </div>
                </form>
                {%endif%}
                <hr>
                <h6>Pagos registrados</h6>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Medio</th> 
                            <th>Registró</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tablaPagosBody">
                        {% include 'presupuestos/partials/_tabla_pagos.html' %}
                    </tbody>
                </table>

                <div class="d-flex justify-content-between mt-2">
                    <p><strong id="totalCalculado">Total pagado: ${{ total_pagado|moneda_ar }}</strong></p>
                    <p><strong id="totalSaldo">Saldo: ${{ saldo|moneda_ar }}</strong></p>
                </div>
                        
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar cierre -->
    <div class="modal fade" id="modalCerrar" tabindex="-1" aria-labelledby="modalCerrarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-sm">
        <div class="modal-header bg-danger text-white">
            <h6 class="modal-title" id="modalCerrarLabel"><i class="fas fa-lock me-2"></i> Cerrar presupuesto</h6>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
            <p>¿Deseás cerrar este presupuesto? No podrás editarlo ni agregar pagos.</p>
        </div>
        <div class="modal-footer justify-content-center border-0">
            <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger btn-sm" id="btnCerrarPresupuesto" data-presupuesto-id="{{ presupuesto.id }}">
            <i class="fas fa-lock"></i> Confirmar cierre
            </button>
        </div>
        </div>
    </div>
    </div>


    <!-- Modal Historial -->
    <div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <!-- Encabezado profesional -->
                <div class="modal-header text-white" style="background: linear-gradient(90deg,#0d6efd,#6610f2);">
                    <h4 class="modal-title d-flex align-items-center" id="modalHistorialLabel">
                        <i class="fas fa-history me-2" style="font-size:1.5rem;"></i> Historial de cambios del Presupuesto
                    </h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <!-- Vista listado -->
                    <div id="vistaListadoHistorial" class="row g-3">
                        <!-- JS generará cards aquí -->
                    </div>

                    <!-- Vista detalle -->
                    <div id="vistaDetalleHistorial" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-sm btn-secondary" id="btnVolverListado">
                                ← Volver al historial
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">
                                Cerrar
                            </button>
                        </div>
                        <div id="detalleHistorialContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Registro de Pago -->
    <div class="modal fade" id="modalConfirmarPago" tabindex="-1" aria-labelledby="modalConfirmarPagoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-sm">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title" id="modalConfirmarPagoLabel">
                        <i class="fas fa-money-bill-wave me-2"></i> Confirmar pago
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">¿Deseás registrar este pago?</p>
                    <small class="text-muted">Esta acción guardará el pago en el sistema.</small>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success btn-sm" id="btnConfirmarPago">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar autorizacion -->
    <div class="modal fade" id="modalAutorizar" tabindex="-1" aria-labelledby="modalAutorizarLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-sm">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title" id="modalAutorizarLabel">
                        <i class="fas fa-money-bill-wave me-2"></i> Confirmar autorizacion
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">¿Deseás autorizar este presupuesto?</p> 
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success btn-sm" id="btnAutorizar" data-presupuesto-id="{{ presupuesto.id }}">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Eliminación de Pago -->
    <div class="modal fade" id="modalEliminarPago" tabindex="-1" aria-labelledby="modalEliminarPagoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-sm">
                <div class="modal-header bg-danger text-white">
                    <h6 class="modal-title" id="modalEliminarPagoLabel">
                        <i class="fas fa-trash-alt me-2"></i> Eliminar pago
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">¿Seguro que querés eliminar este pago?</p>
                    <small class="text-muted">Esta acción no se puede deshacer.</small>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarEliminarPago">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>



</div>
<script>
(function() {
    // 🔹 Paso 1: Reemplaza la entrada actual, eliminando la de edición del historial
    window.history.replaceState(null, "", window.location.href);

    // 🔹 Paso 2: Empuja una nueva entrada "limpia"
    window.history.pushState(null, "", window.location.href);
    console.log("Aca si estoy entrando aunque no creas")
    // 🔹 Paso 3: Si intenta volver atrás, redirige al listado
    window.addEventListener("popstate", function () {
        window.location.replace("{% url 'presupuestos_app:presupuestos' %}");
    });
})();
document.addEventListener("DOMContentLoaded", function() {
    const vistaListado = document.getElementById("vistaListadoHistorial");
    const vistaDetalle = document.getElementById("vistaDetalleHistorial");
    const detalleContent = document.getElementById("detalleHistorialContent");
    const btnVolver = document.getElementById("btnVolverListado");
    const historial = JSON.parse('{{ historial_json|escapejs }}'); 
    // Generar listado con cards profesionales
    let listadoHTML = '';
    historial.forEach((h, index) => {
        listadoHTML += `
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm border-0 h-100 hover-shadow cursor-pointer ver-detalle-historial" data-index="${index}">
                    <div class="card-body">
                        <h5 class="card-title">Versión ${index+1}</h5>
                        <p class="card-text mb-1"><strong>Fecha:</strong> ${h.fecha}</p> 
                        <p class="card-text text-truncate"><strong>Paciente:</strong> ${h.paciente.nombre}</p>
                        <p class="card-text text-truncate"><strong>Usuario:</strong> ${h.user}</p>
                    </div>
                </div>
            </div>
        `;
    });
    vistaListado.innerHTML = listadoHTML;

    // Click para detalle
    // Click para detalle
    document.querySelectorAll(".ver-detalle-historial").forEach(item => {
        item.addEventListener("click", function(e) {
            const h = historial[this.dataset.index];
            let html = `
            <div class="card shadow-sm border-0 mb-3">
                <!-- Encabezado vistoso y compacto -->
                <div class="card-header bg-primary text-white py-2 px-3 rounded-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">Historial Versión ${parseInt(this.dataset.index)+1}</h6>
                            <div><small>Fecha: ${h.fecha}</small></div>
                            <div><small>Usuario: ${h.user}</small></div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark">Total: $${h.total.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div class="card-body p-3">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <h6 class="mb-1">Paciente</h6>
                            <p class="mb-0"><strong>Nombre:</strong> ${h.paciente.nombre}</p>
                            <p class="mb-0"><strong>DNI:</strong> ${h.paciente.dni}</p>
                            <p class="mb-0"><strong>Edad:</strong> ${h.paciente.edad}</p>
                            <p class="mb-0"><strong>Teléfono:</strong> ${h.paciente.telefono}</p>
                            <p class="mb-0"><strong>Email:</strong> ${h.paciente.email}</p>
                            <p class="mb-0"><strong>Obra Social:</strong> ${h.paciente.obra_social}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-1">Médico</h6>
                            <p class="mb-0">${h.medico}</p>
                            <h6 class="mt-2 mb-1">Estado</h6>
                            <p class="mb-0">${h.estado}</p>
                            ${h.motivo_no_concretado ? `<p class="mb-0"><strong>Motivo No Concretado:</strong> ${h.motivo_no_concretado}</p>` : ''}
                        </div>
                    </div>

                    <hr class="my-2">

                    <h6>Diagnóstico</h6>
                    <p>${h.diagnostico}</p>

                    <h6 class="mt-3">Prestaciones</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Tipo</th>
                                    <th>Prestación</th>
                                    <th>Cant.</th>
                                    <th>Precio U.</th>
                                    <th>Importe</th>
                                    <th>IVA</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            h.items.forEach(it => {
                html += `
                    <tr>
                        <td>${it.codigo}</td>
                        <td>${it.tipo}</td>
                        <td>${it.prestacion}</td>
                        <td>${it.cantidad}</td>
                        <td>$${it.precio.toFixed(2)}</td>
                        <td>$${it.importe.toFixed(2)}</td>
                        <td>$${it.iva.toFixed(2)}</td>
                        <td>$${it.subtotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-2">
                        <h5><strong>Total:</strong> $${h.total.toFixed(2)}</h5>
                    </div>
                </div>
            </div>
            `;
            detalleContent.innerHTML = html;
            vistaListado.style.display = "none";
            vistaDetalle.style.display = "block";
        }); 

    });

    btnVolver.addEventListener("click", function() {
        vistaDetalle.style.display = "none";
        vistaListado.style.display = "flex";
    });

 


    const form = document.getElementById("formRegistroPago");
    const tablaPagosBody = document.getElementById("tablaPagosBody");

    let pagoPendienteMonto = null;
    let pagoAEliminar = null;

    // === CONFIRMAR REGISTRO DE PAGO ===
    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const monto = form.querySelector('input[name="monto"]').value;
        if (!monto) {
            alert("Debe ingresar un monto válido.");
            return;
        }

        pagoPendienteMonto = monto;

        // Mostrar modal de confirmación
        const modalPago = new bootstrap.Modal(document.getElementById("modalConfirmarPago"));
        modalPago.show();

        // Vincular botón confirmar del modal
        const btnConfirmar = document.getElementById("btnConfirmarPago");
        btnConfirmar.onclick = function () {
            modalPago.hide();

            const formData = new FormData(form);

            fetch(form.action, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },
                body: formData
            })
                .then((resp) => resp.json())
                .then((data) => {
                    if (data.success) {
                        actualizarListadoPagos(data.pagos_html,data.total_pagado,data.saldo);
                        actualizarEstadoPresupuesto(data.estado);
                        actualizarSaldoDetalle(data.saldo);
                        form.reset();
                    } else {
                        alert(data.error || "Error al registrar el pago.");
                    }
                })
                .catch((err) => alert("Error de conexión: " + err));
        };
    });
    const totalCalculado= document.getElementById("totalCalculado");
    const totalSaldo = document.getElementById('totalSaldo')
     
    // === ELIMINAR PAGO CON MODAL ===
    tablaPagosBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("eliminar-pago")) {
            e.preventDefault();
            pagoAEliminar = e.target.dataset.id;

            const modalEliminar = new bootstrap.Modal(document.getElementById("modalEliminarPago"));
            modalEliminar.show();

            const btnEliminar = document.getElementById("btnConfirmarEliminarPago");
            btnEliminar.onclick = function () {
                modalEliminar.hide();

                const url = "{% url 'presupuestos_app:eliminar_pago' 0 %}".replace("0", pagoAEliminar);

                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                    .then((resp) => resp.json())
                    .then((data) => {
                        if (data.success) { 
                            actualizarEstadoPresupuesto(data.estado);
                            actualizarListadoPagos(data.pagos_html,data.total_pagado,data.saldo);
                            actualizarSaldoDetalle(data.saldo);
                        } else {
                            alert(data.error || "No se pudo eliminar el pago.");
                        }
                    })
                    .catch((err) => alert("Error de conexión: " + err));
            };
        }
    });
    // === ACTUALIZAR TABLA ===
    function actualizarListadoPagos(html,total_pagado,saldo) {
        tablaPagosBody.innerHTML = html;
        totalCalculado.textContent = 'Total pagado: $'+formatearNumeroAR(total_pagado);
        totalSaldo.textContent = 'Saldo: $'+formatearNumeroAR(saldo);
    }
    function formatearNumeroAR(numero) {
        if (isNaN(numero)) return "0,00";
        
        // Asegurarse de que sea float y redondear a 2 decimales
        let n = parseFloat(numero).toFixed(2);

        // Separar parte entera y decimal
        let partes = n.split(".");
        let entero = partes[0];
        let decimal = partes[1];

        // Agregar puntos cada 3 dígitos en la parte entera
        entero = entero.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

        // Combinar con coma para decimales
        return entero + "," + decimal;
    }



    const btnAutorizar = document.getElementById("btnAutorizar");
    const modalAutorizar = new bootstrap.Modal(document.getElementById("modalAutorizar"));
    const estadoSpan = document.getElementById("estado-presupuesto");

    btnAutorizar.onclick = function () {
        const presupuestoId = btnAutorizar.dataset.presupuestoId;
        const url = "{% url 'presupuestos_app:autorizar_presupuesto' 0 %}".replace("0", presupuestoId);

        modalAutorizar.hide();

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                // Cambia el texto del estado sin recargar la página
                estadoSpan.textContent = data.nuevo_estado;
                actualizarEstadoPresupuesto(data.nuevo_estado);
                Swal.fire({
                    icon: "success",
                    title: "Presupuesto autorizado",
                    text: "El estado se actualizó a: " + data.nuevo_estado,
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                // 🔹 Recargar después del cierre del Swal 
                location.reload();
            });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.error || "No se pudo autorizar el presupuesto."
                });
            }
        })
        .catch(err => {
            Swal.fire({
                icon: "error",
                title: "Error de conexión",
                text: err
            });
        });
    };
    
    function actualizarSaldoDetalle(saldo){
        const saldoElem = document.getElementById("saldo-detalle");
        saldoElem.textContent = "$" + formatearNumeroAR(saldo);
    }
    function actualizarEstadoPresupuesto(nuevoEstadoTexto) {
        const estadoSpan = document.getElementById("estado-presupuesto");

        // Limpia todas las clases previas de estilo
        estadoSpan.className = "estado-badge";

        // Define colores y estilos según el estado
        switch (nuevoEstadoTexto.toLowerCase()) {
            case "pendiente":
                estadoSpan.style.backgroundColor = "#ffc107"; // amarillo
                estadoSpan.style.color = "#000";
                break;
            case "autorizado":
                estadoSpan.style.backgroundColor = "#17a2b8"; // celeste
                estadoSpan.style.color = "#fff";
                break;
            case "en curso":
                estadoSpan.style.backgroundColor = "#28a745"; // a 
                estadoSpan.style.color = "#fff";
                break;
            case "cerrado":
                estadoSpan.style.backgroundColor = "#6f42c1"; // verde
                estadoSpan.style.color = "#fff";
                break;
            case "expirado":
                estadoSpan.style.backgroundColor = "#dc3545"; // rojo
                estadoSpan.style.color = "#fff";
                break;
            default:
                estadoSpan.style.backgroundColor = "#6c757d"; // gris
                estadoSpan.style.color = "#fff";
        }

        // Agrega efecto visual de transición suave
        estadoSpan.style.transition = "all 0.5s ease";
        estadoSpan.style.transform = "scale(1.2)";
        setTimeout(() => {
            estadoSpan.style.transform = "scale(1)";
        }, 300);

        // Actualiza el texto del estado
        estadoSpan.textContent = nuevoEstadoTexto;
    }
});


const btnCerrar = document.getElementById("btnCerrarPresupuesto");
const modalCerrar = new bootstrap.Modal(document.getElementById("modalCerrar"));
const estadoSpan = document.getElementById("estado-presupuesto");

if (btnCerrar) {
    btnCerrar.onclick = function() {
        const id = btnCerrar.dataset.presupuestoId;
        const url = "{% url 'presupuestos_app:cerrar_presupuesto' 0 %}".replace("0", id);

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(resp => resp.json())
        .then(data => {
            modalCerrar.hide();
            if (data.success) {
                Swal.fire({
                    icon: "success",
                    title: "Presupuesto cerrado",
                    text: "Ya no se puede modificar este presupuesto.",
                    timer: 2000,
                    showConfirmButton: false
                });
                estadoSpan.textContent = data.nuevo_estado;
                estadoSpan.className = "badge bg-purple";
                document.querySelectorAll(".btn-warning, .btn-success, .btn-info").forEach(b => b.disabled = true);
                // 🔹 Recarga la página luego de un breve delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: data.error
                });
            }
        })
        .catch(err => {
            Swal.fire({
                icon: "error",
                title: "Error de conexión",
                text: err
            });
        });
    };
}


</script>

<style>
.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
}
.cursor-pointer {
    cursor: pointer;
}
.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.card-header {
    border-bottom: 2px solid #0d6efd;
}
.card-header h6 {
    font-weight: 600;
    font-size: 0.95rem;
}
.card-header small {
    font-size: 0.8rem;
    opacity: 0.8;
}
.badge {
    font-size: 0.85rem;
    padding: 0.35em 0.6em;
}
</style> 
{%endblock%}