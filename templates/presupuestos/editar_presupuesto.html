{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
:root{
    --input-padding: 0.28rem;
    --font-size-base: 0.88rem;
    --table-font-size: 0.70rem;
    --card-padding: 0.55rem;
    --card-radius: 8px;
}

.card { border: none; border-radius: var(--card-radius); margin-bottom: 0.25rem; box-shadow: 0 2px 4px rgba(0,0,0,0.04); padding: var(--card-padding); font-size: var(--font-size-base); }
.card-title { font-size: 0.95rem; font-weight: 600; color: #495057; margin-bottom: 0.45rem; }
.form-control, .form-select { border: 1px solid #dee2e6; border-radius: 6px; padding: var(--input-padding) 0.5rem; font-size: 0.76rem; background-color: #fff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.03); transition: all 0.15s ease-in-out; height: 25px; }
label { font-size: 0.79rem; color: #191b1c; margin-bottom: 2px; display: block; }
.table { font-size: var(--table-font-size); margin-bottom: 0; }
.table td, .table th { padding: 0.28rem; vertical-align: middle; white-space: nowrap; }
.btn-sm { padding: 0.18rem 0.45rem; border-radius: 6px; font-size: 0.78rem; }
.card-body.text-end p, .card-body.text-end h5 { margin: 0.12rem 0; font-size: 0.9rem; }
.container.my-4 { max-width: 1200px; }
</style>

<div class="container my-4">
    <h3 class="text-primary"><i class="fas fa-file-medical"></i> Editar Presupuesto</h3>
    <form method="POST" id="form-presupuesto" autocomplete="off">
        {% csrf_token %}

        <!-- Datos del paciente -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title">Datos del Paciente</h5>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label>Nombre</label>
                        <input  type="text" name="paciente_nombre" class="form-control" value="{{ presupuesto.paciente_nombre }}" required>
                    </div>
                    <div class="col-md-2">
                        <label>DNI</label>
                        <input disabled type="text" name="paciente_dni" class="form-control" value="{{ presupuesto.paciente_dni }}">
                    </div>
                    <div class="col-md-2">
                        <label>Edad</label>
                        <input type="number" name="paciente_edad" class="form-control" value="{{ presupuesto.paciente_edad }}">
                    </div>
                    <div class="col-md-4">
                        <label>Direcci贸n</label>
                        <input type="text" name="paciente_direccion" class="form-control" value="{{ presupuesto.paciente_direccion }}">
                    </div>
                    <div class="col-md-3">
                        <label>Tel茅fono</label>
                        <input type="text" name="paciente_telefono" class="form-control" value="{{ presupuesto.paciente_telefono }}">
                    </div>
                    <div class="col-md-3">
                        <label>Email</label>
                        <input type="text" name="paciente_email" class="form-control" value="{{ presupuesto.paciente_email }}">
                    </div>
                    <div class="col-md-3">
                        <label>Obra Social</label>
                        <input disabled type="text" name="obra_social" class="form-control" value="{{ presupuesto.obra_social }}">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">Datos M茅dicos</h5>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label>M茅dico</label>
                        <input disabled type="text" name="medico" class="form-control" value="{{ presupuesto.medico }}">
                    </div>
                    <div class="col-md-6">
                        <label>Diagn贸stico</label>
                        <input type="text" name="diagnostico" class="form-control" value="{{ presupuesto.diagnostico }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de prestaciones -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Prestaciones
                    <div class="d-flex align-items-center gap-3">
                        <label class="form-check-label" for="chk-iva" >IVA</label>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="chek-iva" {% if tiene_iva %}checked{% endif %}>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="med-prop" class="me-1 mb-0">Prop. Medicamentos</label>
                            <select id="med-prop" class="form-select form-select-sm" style="width: 80px;">
                                <option value="40">40%</option>
                                <option value="45">45%</option>
                                <option value="50" selected>50%</option>
                                <option value="55">55%</option>
                                <option value="60">60%</option>
                            </select>
                        </div>
                        <button type="button" id="btn-medicamentos" class="btn btn-info btn-sm"><i class="fas fa-pills"></i> Agregar Prop Medicamentos</button>
                    </div>
                </h5>

                <div class="table-responsive mt-2">
                    <table class="table table-bordered align-middle" id="tabla-prestaciones">
                        <thead class="table-light">
                            <tr>
                                <th>C贸digo</th>
                                <th>Tipo</th>
                                <th>Prestaci贸n</th>
                                <th>Cant.</th>
                                <th>Precio U.</th>
                                <th>Importe</th>
                                <th>IVA</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in presupuesto.items.all %}
                            <tr class="fila-detalle">
                                <td><input type="text" name="codigo" class="form-control codigo" value="{{ item.codigo }}"></td>
                                <td>
                                    <select name="tipo" class="form-control tipo">
                                        <option value="gastos" {% if item.tipo == "gastos" %}selected{% endif %}>Gastos</option>
                                        <option value="especialista" {% if item.tipo == "especialista" %}selected{% endif %}>Especialista</option>
                                        <option value="todo" {% if item.tipo == "todo" %}selected{% endif %}>Todo</option>
                                    </select>
                                </td>
                                <td><input type="text" name="prestacion" class="form-control prestacion" value="{{ item.prestacion }}"></td>
                                <td><input type="number" name="cantidad" class="form-control cantidad" value="{{ item.cantidad }}"></td>
                                <td><input type="number" name="precio" class="form-control precio" step="0.01" value="{{ item.precio }}"></td>
                                <td><input type="text" name="importe" class="form-control importe" readonly value="{{ item.importe }}"></td>
                                <td><input type="text" name="iva" class="form-control iva" readonly value="{{ item.iva }}"></td>
                                <td><input type="text" name="subtotal" class="form-control subtotal" readonly value="{{ item.subtotal }}"></td>
                                <td><button type="button" class="btn btn-danger btn-sm eliminar-fila">X</button></td>
                            </tr>
                            {% empty %}
                            <tr class="fila-detalle">
                                <!-- fila vac铆a -->
                                <td><input type="text" name="codigo" class="form-control codigo"></td>
                                <td>
                                    <select name="tipo" class="form-control tipo">
                                        <option value="gastos" selected>Gastos</option>
                                        <option value="especialista">Especialista</option>
                                        <option value="todo">Todo</option>
                                    </select>
                                </td>
                                <td><input type="text" name="prestacion" class="form-control prestacion"></td>
                                <td><input type="number" name="cantidad" class="form-control cantidad" value="1"></td>
                                <td><input type="number" name="precio" class="form-control precio" step="0.01" value="0.00"></td>
                                <td><input type="text" name="importe" class="form-control importe" readonly value="0.00"></td>
                                <td><input type="text" name="iva" class="form-control iva" readonly value="0.00"></td>
                                <td><input type="text" name="subtotal" class="form-control subtotal" readonly value="0.00"></td>
                                <td><button type="button" class="btn btn-danger btn-sm eliminar-fila">X</button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <button type="button" id="agregar-fila" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Agregar Prestaci贸n</button>
                </div>
            </div>
        </div>

        <!-- Totales -->
        <div class="card shadow-sm mb-2">
            <div class="card-body text-end">
                <p><strong>Subtotal:</strong> $<span id="subtotal">0.00</span></p>
                <p><strong>IVA (21%):</strong> $<span id="iva">0.00</span></p>
                <h5><strong>Total:</strong> $<span id="total">0.00</span></h5>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar Cambios</button>
        </div>
    </form>
</div>


<script>
/*
  Par谩metros JS que pod茅s cambiar
  - TAX_RATE: tasa de IVA (ej: 0.21)
  - DECIMALS: cantidad de decimales que quer茅s mostrar
*/
const TAX_RATE = 0.21;
const DECIMALS = 2;

/* Actualiza una fila dada (calcula importe, iva y total fila) */
function actualizarFila(tr){
    const precioEl = tr.querySelector(".precio");
    const cantidadEl = tr.querySelector(".cantidad");
    const importeEl = tr.querySelector(".importe");
    const ivaEl = tr.querySelector(".iva");
    const subtotalEl = tr.querySelector(".subtotal");

    const precio = parseFloat(precioEl.value) || 0;
    const cantidad = parseFloat(cantidadEl.value) || 0;

    const importe = precio * cantidad;               // sin IVA
    const iva = importe * TAX_RATE;                 // IVA por fila
    const total = importe + iva;                    // total por fila

    importeEl.value = importe.toFixed(DECIMALS);
    ivaEl.value = iva.toFixed(DECIMALS);
    subtotalEl.value = total.toFixed(DECIMALS);
}


/*Aca esta funcion agrega proporcionales en medicamento*/

document.getElementById("btn-medicamentos").addEventListener("click", function() {
    const porcentaje = parseFloat(document.getElementById("med-prop").value) / 100; // 0.4, 0.5, etc.
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;

    // Funci贸n auxiliar para procesar un c贸digo base y crear/actualizar fila proporcional
    function procesarCodigoBase(codigoBase, codigoDestino, nombrePrestacion) {
        // Buscar fila existente
        let filaExistente = Array.from(tbody.querySelectorAll("tr")).find(f => f.querySelector(".codigo").value === codigoDestino);

        // Sumamos cantidades y precios proporcionales de todas las filas con codigoBase
        let totalCantidad = 0;
        let totalPrecio = 0;

        Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
            const codigo = fila.querySelector(".codigo").value.trim();
            if (codigo === codigoBase) {
                const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
                const precioOriginal = parseFloat(fila.querySelector(".precio").value) || 0;
                totalCantidad += cantidad;
                totalPrecio += precioOriginal * porcentaje * cantidad;
            }
        });

        if (totalCantidad === 0) return; // no hay filas base, nada que hacer

        const iva = ivaIncluido ? totalPrecio * TAX_RATE : 0;
        const subtotal = totalPrecio + iva;

        if (!filaExistente) {
            // Creamos nueva fila basada en la primera fila del codigoBase
            const filaBase = Array.from(tbody.querySelectorAll("tr")).find(f => f.querySelector(".codigo").value.trim() === codigoBase);
            const nuevaFila = filaBase.cloneNode(true);

            // Seteamos valores
            nuevaFila.querySelector(".codigo").value = codigoDestino;
            nuevaFila.querySelector(".prestacion").value = nombrePrestacion;
            nuevaFila.querySelector(".cantidad").value = totalCantidad;
            nuevaFila.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS); // precio unitario proporcional
            nuevaFila.querySelector(".importe").value = totalPrecio.toFixed(DECIMALS);
            nuevaFila.querySelector(".iva").value = iva.toFixed(DECIMALS);
            nuevaFila.querySelector(".subtotal").value = subtotal.toFixed(DECIMALS);

            // Insertamos al final
            tbody.appendChild(nuevaFila);
        } else {
            // Actualizamos fila existente
            filaExistente.querySelector(".cantidad").value = totalCantidad;
            filaExistente.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS);
            filaExistente.querySelector(".importe").value = totalPrecio.toFixed(DECIMALS);
            filaExistente.querySelector(".iva").value = iva.toFixed(DECIMALS);
            filaExistente.querySelector(".subtotal").value = subtotal.toFixed(DECIMALS);
        }
    }

    // Procesamos ambos c贸digos
    procesarCodigoBase("430101", "medint", "Medicamentos y descartables en Internado");
    procesarCodigoBase("400101", "meduti", "Medicamentos y descartables en UTI");

    // Recalculamos totales generales
    calcularTotales();
});

 /* Recalcula totales generales */
function calcularTotales() {
    let subtotal = 0;
    let ivaTotal = 0;
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;
    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => {
        const cantidad = parseFloat(tr.querySelector(".cantidad")?.value) || 0;
        const precio = parseFloat(tr.querySelector(".precio")?.value) || 0;

        const importe = cantidad * precio;
        let iva = ivaIncluido ? importe * TAX_RATE : 0;

        const totalFila = importe + iva;

        // Actualizamos fila
        tr.querySelector(".importe").value = importe.toFixed(DECIMALS);
        tr.querySelector(".iva").value = iva.toFixed(DECIMALS);
        tr.querySelector(".subtotal").value = totalFila.toFixed(DECIMALS);

        subtotal += importe;
        ivaTotal += iva;
    });

    // Control del checkbox IVA
   
    if (!ivaIncluido) ivaTotal = 0;

    const total = subtotal + ivaTotal;

    // Actualizamos pantalla
    document.getElementById("subtotal").textContent = subtotal.toFixed(DECIMALS);
    document.getElementById("iva").textContent = ivaTotal.toFixed(DECIMALS);
    document.getElementById("total").textContent = total.toFixed(DECIMALS);
}

/* Delegaci贸n de eventos: input y cambios en la tabla */
document.addEventListener("input", function(e){
    const tr = e.target.closest("tr");
    if (!tr || !tr.closest("#tabla-prestaciones")) return;

    // Si cambiaron precio o cantidad o si hay campos editables, recalcular fila
    if (e.target.classList.contains("precio") || e.target.classList.contains("cantidad") || e.target.classList.contains("codigo") || e.target.classList.contains("prestacion")){
        actualizarFila(tr);
        calcularTotales();
    }
});

/* Listener para cuando se pierde foco en campo 'codigo' -> busca prestaci贸n v铆a fetch */
document.getElementById("tabla-prestaciones").addEventListener("blur", async function(e) {
    if (e.target && e.target.classList.contains("codigo")){
        let codigo = e.target.value.trim();
        if (codigo !== "") {
            let fila = e.target.closest("tr");
            
            try {
                // Ajust谩 la URL si tu named URL es diferente
                const url = "{% url 'presupuestos_app:get_prestacion' codigo='__codigo__' %}".replace("__codigo__", encodeURIComponent(codigo));

                let resp = await fetch(url);
                if (!resp.ok) throw new Error("Error en la respuesta del servidor");

                let data = await resp.json();
                // Esperamos que la respuesta JSON tenga { nombre, precio }
                fila.querySelector(".tipo").value="gastos"; 
                fila.querySelector(".prestacion").value = data.nombre || fila.querySelector(".prestacion").value;
                fila.querySelector(".precio").value = (parseFloat(data.precio) || 0).toFixed(DECIMALS);
                // forzamos cantidad a 1 si estaba vac铆o
                if (!fila.querySelector(".cantidad").value) fila.querySelector(".cantidad").value = 1;

                // recalcular
                actualizarFila(fila);
                calcularTotales();
            } catch (err) {
                console.error("Error:", err);
                // no hacemos un alert intrusivo; pod茅s activar si quer茅s:
                // alert("No se encontr贸 la prestaci贸n para el c贸digo " + codigo);
            }
        }
    }
}, true); // useCapture true para capturar blur en inputs
 

/* Listener para cuando se cambie el tipo de gasto */
document.querySelectorAll("#tabla-prestaciones").forEach((tabla) => {
    tabla.addEventListener("change", function (e) {
        if (e.target && e.target.classList.contains("tipo")) {
            let fila = e.target.closest("tr");
            let tipo = e.target.value;
            let codigo = fila.querySelector(".codigo").value;  //  tomo el c贸digo de esa fila

            // construyo la URL din谩mica con Django
            const url = "{% url 'presupuestos_app:get_tipo' codigo='__codigo__' %}"
                            .replace("__codigo__", encodeURIComponent(codigo));

            fetch(`${url}?tipo=${tipo}`)
                .then((response) => response.json())
                .then((data) => {
                    let cantidad = parseFloat(fila.querySelector(".cantidad").value) || 1;
                    let precio = parseFloat(data.precio);
                    let iva = parseFloat(data.precio)*0.21;
                    let total = precio + iva;

                    // Impactamos en los campos
                    fila.querySelector(".precio").value = precio.toFixed(2);
                    fila.querySelector(".importe").value = (precio * cantidad).toFixed(2);
                    fila.querySelector(".iva").value = (iva * cantidad).toFixed(2);
                    fila.querySelector(".subtotal").value = (total * cantidad).toFixed(2);
                })
                .catch((error) => {
                    console.error("Error al traer datos:", error);
                });
        }
    });
});


/* Agregar fila - clonamos la primera fila y reseteamos valores */
document.getElementById("agregar-fila").addEventListener("click", function(){
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const template = tbody.querySelector("tr.fila-detalle");
    const fila = template.cloneNode(true);

    // resetear inputs
    fila.querySelectorAll("input").forEach(el => {
        if (el.classList.contains("cantidad")) el.value = 1;
        else if (el.classList.contains("precio")) el.value = (0).toFixed(DECIMALS);
        else el.value = "";
    });

    // recalcular fila reci茅n agregada
    actualizarFila(fila);
    tbody.appendChild(fila);
    calcularTotales();
});

/* Eliminar fila (delegado) */
document.addEventListener("click", function(e){
    if (e.target.classList.contains("eliminar-fila")){
        // Evita borrar la 煤ltima fila si quer茅s (opcional)
        const tbody = document.querySelector("#tabla-prestaciones tbody");
        if (tbody.querySelectorAll("tr").length === 1) {
            // si no quer茅s permitir eliminar la 煤ltima fila, limpiarla en su lugar:
            const tr = e.target.closest("tr");
            tr.querySelectorAll("input").forEach(i => i.value = (i.classList.contains("cantidad") ? 1 : ""));
        } else {
            e.target.closest("tr").remove();
        }
        calcularTotales();
    }
});

/* Inicializaci贸n: recalcula en caso que haya valores precargados */
document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => actualizarFila(tr));
    calcularTotales();
    document.getElementById("chek-iva").addEventListener("change", calcularTotales);

});
</script>

{% endblock %}
