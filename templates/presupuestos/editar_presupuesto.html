{% extends 'base2.html' %}
{% load static %}
{% block content %}

<style>
:root{
    --input-padding: 0.28rem;
    --font-size-base: 0.88rem;
    --table-font-size: 0.70rem;
    --card-padding: 0.55rem;
    --card-radius: 8px;
}
textarea.form-control {
    height: auto !important;     /* ignora la altura fija */
    min-height: 100px !important; /* define un tamaño mínimo real */
    line-height: 1.3;
    resize: vertical;            /* permite agrandar manualmente */
}

/* Compactar las cards */
.card {
    border: none;
    border-radius: var(--card-radius);
    margin-bottom: 0.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    padding: var(--card-padding);
    font-size: var(--font-size-base);
}

/* Títulos más discretos */
.card-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.45rem;
}

/* Inputs compactos */
.form-control, .form-select {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: var(--input-padding) 0.5rem;
    font-size: 0.76rem;
    background-color: #fff;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
    transition: all 0.15s ease-in-out;
    height: 25px; /* bajar si querés más compacto */
}


.form-control:focus, .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 4px rgba(0,123,255,0.18);
}

/* Etiquetas más pequeñas */
label {
    font-size: 0.79rem;
    color: #191b1c;
    margin-bottom: 2px;
    display: block;
}

/* Tabla ultra compacta */
.table {
    font-size: var(--table-font-size);
    margin-bottom: 0;
}

.table td, .table th {
    padding: 0.28rem;
    vertical-align: middle;
    white-space: nowrap;
}

/* Botones más sutiles */
.btn-sm {
    padding: 0.18rem 0.45rem;
    border-radius: 6px;
    font-size: 0.78rem;
}

/* Totales más prolijos */
.card-body.text-end p, 
.card-body.text-end h5 {
    margin: 0.12rem 0;
    font-size: 0.9rem;
}

/* Para forzar que la vista ocupe más ancho en pantallas grandes */
.container.my-4 {
    max-width: 1200px;
}

/* Iconos de acción pequeños */
.btn-danger.btn-sm, .btn-success.btn-sm {
    line-height: 1;
    height: 30px;
}
/* Alinear inputs a la derecha */
#tabla-prestaciones input.precio,
#tabla-prestaciones input.importe,
#tabla-prestaciones input.iva,
#tabla-prestaciones input.subtotal {
    text-align: right;
}


.input-group-sm > .form-control,
.input-group-sm > .btn {
    height: 24px; /* asegura que coincida con los demás */
}

td {
    vertical-align: middle !important;
}
.lupa-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;            /* elimina relleno interno extra */
  width: 38px;           /* igual ancho que alto */
  height: 38px;          /* mismo alto que el input */
}

.lupa-btn i {
  font-size: 14px;       /* ajusta tamaño del ícono */
  margin: 0;             /* sin desplazamiento */
}









</style>

<div class="container my-4">
    <h3 class="text-primary"><i class="fas fa-file-medical"></i> Editar Presupuesto</h3>
    <form method="POST" id="form-presupuesto" autocomplete="off" 
      method="post"
      action="{% url 'presupuestos_app:editar_presupuesto' presupuesto.id %}">
        {% csrf_token %}

        <!-- Datos del paciente -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title">Datos del Paciente</h5>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label>Nombre</label>
                        <input  type="text" name="paciente_nombre" class="form-control" value="{{ presupuesto.paciente_nombre }}" required>
                    </div>
                    <div class="col-md-2">
                        <label>DNI</label>
                        <input disabled type="text" name="paciente_dni" class="form-control" value="{{ presupuesto.paciente_dni }}">
                    </div>
                    <div class="col-md-2">
                        <label>Edad</label>
                        <input type="number" name="paciente_edad" class="form-control" value="{{ presupuesto.paciente_edad }}">
                    </div>
                    <div class="col-md-4">
                        <label>Dirección</label>
                        <input type="text" name="paciente_direccion" class="form-control" value="{{ presupuesto.paciente_direccion }}">
                    </div>
                    <div class="col-md-3">
                        <label>Teléfono</label>
                        <input type="text" name="paciente_telefono" class="form-control" value="{{ presupuesto.paciente_telefono }}">
                    </div>
                    <div class="col-md-3">
                        <label>Email</label>
                        <input type="text" name="paciente_email" class="form-control" value="{{ presupuesto.paciente_email }}">
                    </div>
                    <div class="col-md-3">
                        <label>Obra Social</label>
                        <input disabled type="text" name="obra_social" class="form-control" value="{{ presupuesto.obra_social }}">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">Datos Adicionales</h5>
                <div class="row g-2">
                    <div class="col-md-6">
                        <label>Médico</label>
                        <input disabled type="text" name="medico" class="form-control" value="{{ presupuesto.medico }}">
                    </div>
                    <div class="col-md-6">
                        <label>Diagnóstico</label>
                        <input type="text" name="diagnostico" class="form-control" value="{{ presupuesto.diagnostico }}">
                    </div>
                    <div class="col-md-6">
                        <label>Observaciones</label>
                        <input type="text" name="observaciones" class="form-control" autocomplete="off" value="{{ presupuesto.motivo_no_concretado }}">
                    </div>
                    <div class="col-md-2">
                        <label>Episodio asociado</label>
                        <input type="text" name="episodio" class="form-control" autocomplete="off" value="{{ presupuesto.episodio }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de prestaciones -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">
                    Prestaciones
                    <div class="d-flex align-items-center gap-3">
                        <label class="form-check-label" for="chk-iva" >IVA</label>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="checkbox" id="chek-iva" {% if tiene_iva %}checked{% endif %}>
                        </div>
                        <div class="d-flex align-items-center">
                            <label for="med-prop" class="me-1 mb-0">Prop. Medicamentos</label>
                            <select id="med-prop" class="form-select form-select-sm" style="width: 80px;">
                                <option value="40">40%</option>
                                <option value="45">45%</option>
                                <option value="50" selected>50%</option>
                                <option value="55">55%</option>
                                <option value="60">60%</option>
                            </select>
                        </div>
                        <button type="button" id="btn-medicamentos" class="btn btn-info btn-sm"><i class="fas fa-pills"></i> Agregar Prop Medicamentos</button>
                    </div>
                </h5>

                <div class="table-responsive mt-2">
                    <table class="table table-bordered align-middle" id="tabla-prestaciones">
                        <thead class="table-light">
                            <tr>
                                <th style="width:90px">Código</th>
                                <th style="width:70px">Tipo</th>
                                <th style="width:240px">Prestación</th> 
                                <th style="width:50px">Cant.</th>
                                <th style="width:100px">Precio U.</th>
                                <th style="width:100px">Importe</th>
                                <th style="width:100px">IVA</th>
                                <th style="width:100px">Total</th>
                                <th style="width:45px"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in itemspresupuesto %}
                            <tr class="fila-detalle"> 
                                <td >
                                    <div class="input-group input-group-sm">
                                        <input type="text" name="codigo" class="form-control codigo" value="{{ item.codigo }}">
                                        <button type="button" class="btn btn-outline-secondary lupa-btn" data-bs-toggle="modal" data-bs-target="#modalBusqueda">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </td>                                 
                                <td>
                                    <select name="tipo" class="form-control tipo">
                                        <option value="gastos" {% if item.tipo == "gastos" %}selected{% endif %}>Gastos</option>
                                        <option value="especialista" {% if item.tipo == "especialista" %}selected{% endif %}>Especialista</option>
                                        <option value="todo" {% if item.tipo == "todo" %}selected{% endif %}>Todo</option>
                                    </select>
                                </td>
                                <td><input type="text" name="prestacion" class="form-control prestacion" value="{{ item.prestacion }}"></td>
                                <td><input type="number" name="cantidad" class="form-control cantidad" value="{{ item.cantidad }}"></td>
                                <td><input type="number" name="precio" class="form-control precio" step="0.01" value="{{ item.precio|floatformat:2}}"></td>
                                <td><input type="text" name="importe" class="form-control importe" readonly value="{{ item.importe }}"></td>
                                <td><input type="text" name="iva" class="form-control iva" readonly value="{{ item.iva }}"></td>
                                <td><input type="text" name="subtotal" class="form-control subtotal" readonly value="{{ item.subtotal }}"></td>
                                <td class="d-flex gap-1 justify-content-center">
                                    <!-- Botón comentario -->
                                    <button type="button" class="btn btn-outline-secondary btn-sm btn-comentario" title="Agregar comentario">
                                        <i class="fas fa-comment-dots"></i>
                                    </button>

                                    <!-- Botón eliminar -->
                                    <button type="button" class="btn btn-danger btn-sm eliminar-fila">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    <!-- Input oculto donde se guardará el comentario -->
                                    <input type="hidden" value="{{ item.comentario }}"  name="comentario" class="comentario">
                                </td>
                            </tr>
                            {% empty %}
                            <tr class="fila-detalle">
                                <!-- fila vacía -->
                                <td><input type="text" name="codigo" class="form-control codigo"></td>
                                <td>
                                    <select name="tipo" class="form-control tipo">
                                        <option value="gastos" selected>Gastos</option>
                                        <option value="especialista">Especialista</option>
                                        <option value="todo">Todo</option>
                                    </select>
                                </td>
                                <td><input type="text" name="prestacion" class="form-control prestacion"></td>
                                <td><input type="number" name="cantidad" class="form-control cantidad" value="1"></td>
                                <td><input type="number" name="precio" class="form-control precio" step="0.01" value="0.00"></td>
                                <td><input type="text" name="importe" class="form-control importe" readonly value="0.00"></td>
                                <td><input type="text" name="iva" class="form-control iva" readonly value="0.00"></td>
                                <td><input type="text" name="subtotal" class="form-control subtotal" readonly value="0.00"></td>                                <td class="d-flex gap-1 justify-content-center">
                                    <!-- Botón comentario -->
                                    <button type="button" class="btn btn-outline-secondary btn-sm btn-comentario" title="Agregar comentario">
                                        <i class="fas fa-comment-dots"></i>
                                    </button>

                                    <!-- Botón eliminar -->
                                    <button type="button" class="btn btn-danger btn-sm eliminar-fila">
                                        <i class="fas fa-times"></i>
                                    </button>

                                    <!-- Input oculto donde se guardará el comentario -->
                                    <input type="hidden" name="comentario" class="comentario">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="row">
                    <div class="mt-2 col-md-6">
                        <button type="button" id="agregar-fila" class="btn btn-success btn-sm"><i class="fas fa-plus"></i> Agregar Prestación</button>
                    </div>
                    <div class="card-body text-end mt-0 col-md-6">
                        <p><strong>Importe sin iva:</strong> $<span id="subtotal">0.00</span></p>
                        <p><strong>IVA (21%):</strong> $<span id="iva">0.00</span></p>
                        <h5><strong>Total:</strong> $<span id="total">0.00</span></h5>
                    </div>
                </div>
            </div>
        </div>



          
        <!-- Modal Buscador -->
        <div class="modal fade" id="modalBusqueda" tabindex="-1" aria-labelledby="modalBusquedaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="modalBusquedaLabel">Buscar Nomenclador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="input-group mb-3">
                <input type="text" id="busqueda" class="form-control" placeholder="Buscar por código o nombre...">
                <button type="button" class="btn btn-primary" id="btnBuscar">Buscar</button>
                </div>

                <table class="table table-hover table-sm" id="tablaResultados">
                <thead>
                    <tr>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Gastos</th>
                    <th>Especialista</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llena dinámicamente -->
                </tbody>
                </table>
            </div>
            </div>
        </div>
        </div>

        <!-- Mini modal para comentarios -->
        <div class="modal fade" id="modalComentario" tabindex="-1" aria-labelledby="modalComentarioLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white py-2">
                        <h6 class="modal-title" id="modalComentarioLabel"><i class="fas fa-comment-dots me-2"></i>Comentario</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="textoComentario" class="form-control" rows="1" placeholder="Escribí un comentario..."></textarea>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary btn-sm" id="btnGuardarComentario">Guardar</button>
                    </div>
                </div>
            </div>
        </div>



                <!-- Modal de Confirmación --> 
        <div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-sm">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title" id="modalConfirmacionLabel">
                    <i class="fas fa-save me-2"></i> Confirmar guardado
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-2">¿Deseás guardar los cambios de este presupuesto?</p> 
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnConfirmarGuardar">
                    <i class="fas fa-check"></i> Guardar
                    </button>
                </div>
                </div>
            </div>
        </div> 

        <div class="text-end">
        <button type="button" class="btn btn-secondary" id="btnCancelar"
                onclick="window.location.href='{% url 'presupuestos_app:detalle_presupuesto' presupuesto.id %}'">
            <i class="fas fa-arrow-left"></i> Cancelar Editar
        </button>
        <button type="button" class="btn btn-primary" id="btnGuardarPresupuesto">
            <i class="fas fa-save"></i> Guardar Cambios
        </button>
        </div>
    </form>
</div>



<script>
/* ===========================================
   CONFIGURACIÓN GENERAL
   =========================================== */
const TAX_RATE = 0.21;   // Tasa de IVA
const DECIMALS = 2;      // Cantidad de decimales mostrados

let filaActualBuscador = null; // Fila activa del modal buscador


/* ===========================================
   FORMATEO Y CONVERSIÓN DE NÚMEROS
   =========================================== */

/** Formatea número al estilo argentino (puntos miles, coma decimal). */
function formatearNumeroAR(numero) {
    if (numero === null || numero === undefined || numero === "") return "";
    
    // Eliminar todo lo que no sea número
    numero = numero.toString().replace(/\D/g, '');
    
    // Convertir a float y dividir entre 100 para los decimales
    let n = (parseFloat(numero) / 100).toFixed(2);

    // Separar entero y decimal
    let partes = n.split(".");
    let entero = partes[0];
    let decimal = partes[1];

    // Agregar puntos cada 3 dígitos
    entero = entero.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

    return entero + "," + decimal;
}
/** Convierte string "123.456,78" → 123456.78 */
function parsearNumeroAR(str) {
    if (!str) return 0;
    return parseFloat(str.replace(/\./g, "").replace(",", "."));
}


/*  ===========================================
    Cuando se setea el codigo y el mismo sale de alli
    FOCUS - OFF
    ===========================================  */  


document.getElementById("tabla-prestaciones").addEventListener("blur", async e => {
    if (!e.target.classList.contains("codigo")) return;
    const codigo = e.target.value.trim();
    if (!codigo) return;

    const fila = e.target.closest("tr");
    try {
        const url = "{% url 'presupuestos_app:get_prestacion' codigo='__codigo__' %}"
            .replace("__codigo__", encodeURIComponent(codigo));
        const resp = await fetch(url);
        if (!resp.ok) throw new Error();
        const data = await resp.json();

        fila.querySelector(".tipo").value = "gastos";
        fila.querySelector(".prestacion").value = data.nombre || fila.querySelector(".prestacion").value;
        fila.querySelector(".precio").value = (parseFloat(data.precio) || 0).toFixed(DECIMALS);
        if (!fila.querySelector(".cantidad").value) fila.querySelector(".cantidad").value = 1;


        // 💡 NUEVO: permitir editar si no es de tipo IPS 
        if (data.tipo && data.tipo.toLowerCase() === "particular") {
            fila.querySelector(".precio").removeAttribute("readonly");
            fila.querySelector(".precio").classList.add("bg-light");
        } else {
            fila.querySelector(".precio").setAttribute("readonly", true);
            fila.querySelector(".precio").classList.remove("bg-light");
        }


        calcularTotales();
    } catch {
        console.warn("Prestación no encontrada:", codigo);
    }
}, true);


/*  ===========================================
    Cuando se Busca con el buscador
    BUSCADOR DE PRESTACIONES
    ===========================================  */  



// Guarda la fila actual al abrir modal

document.addEventListener("click", e => {
    if (e.target.closest(".lupa-btn")) {
        filaActualBuscador = e.target.closest("tr");
    }
});

// Buscar prestaciones desde el modal

document.getElementById("btnBuscar").addEventListener("click", async () => {
    const termino = document.getElementById("busqueda").value.trim();
    if (!termino) return alert("Por favor ingresa un término de búsqueda.");

    const tbody = document.querySelector("#tablaResultados tbody");
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Buscando...</td></tr>';

    try {
        const resp = await fetch(`{% url 'presupuestos_app:buscar_nomenclador' %}?q=${encodeURIComponent(termino)}`);
        if (!resp.ok) throw new Error("Error al buscar en el servidor");
        const resultados = await resp.json();

        tbody.innerHTML = resultados.length
            ? resultados.map(item => `
                <tr style="cursor:pointer">
                    <td>${item.codigo}</td>
                    <td>${item.nombre}</td>
                    <td>${item.gastos}</td>
                    <td>${item.especialista}</td>
                </tr>`).join("")
            : '<tr><td colspan="4" class="text-center text-muted">Sin resultados</td></tr>';

        // Vincular click en resultados
        tbody.querySelectorAll("tr").forEach((tr, i) =>
            tr.addEventListener("click", () => seleccionarItem(resultados[i]))
        );
    } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar datos</td></tr>';
    }
});

/** Completa la fila con los datos del ítem seleccionado. */
async function seleccionarItem(item) {
    const modal = bootstrap.Modal.getInstance(document.getElementById("modalBusqueda"));
    modal.hide();
    if (!filaActualBuscador) return;

    const fila = filaActualBuscador;
    fila.querySelector(".codigo").value = item.codigo;

    try {
        const url = "{% url 'presupuestos_app:get_prestacion' codigo='__codigo__' %}"
            .replace("__codigo__", encodeURIComponent(item.codigo));

        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Error en la respuesta del servidor");
        const data = await resp.json();

        fila.querySelector(".tipo").value = "gastos";
        fila.querySelector(".prestacion").value = data.nombre || "";
        fila.querySelector(".precio").value = (parseFloat(data.precio) || 0).toFixed(DECIMALS);
        if (!fila.querySelector(".cantidad").value) fila.querySelector(".cantidad").value = 1; 

        
        // 💡 NUEVO: permitir editar si no es de tipo IPS 
        if (data.tipo && data.tipo.toLowerCase() === "particular") {
            fila.querySelector(".precio").removeAttribute("readonly");
            fila.querySelector(".precio").classList.add("bg-light");
        } else {
            fila.querySelector(".precio").setAttribute("readonly", true);
            fila.querySelector(".precio").classList.remove("bg-light");
        }


        calcularTotales();
    } catch (err) {
        console.error("Error:", err);
        alert("No se encontró la prestación para el código " + item.codigo);
    }
}


/* ===========================================
   CÁLCULOS DE FILA Y TOTALES
   =========================================== */

/** Recalcula los importes de una fila (importe, IVA, subtotal). */
function actualizarFdila(tr) { 
}


/* Actualiza una fila dada (calcula importe, iva y total fila) */
function actualizarFila(tr){
    const precioEl = tr.querySelector(".precio");
    const cantidadEl = tr.querySelector(".cantidad");
    const importeEl = tr.querySelector(".importe");
    const ivaEl = tr.querySelector(".iva");
    const subtotalEl = tr.querySelector(".subtotal");

    const precio = parseFloat(precioEl.value) || 0;
    const cantidad = parseFloat(cantidadEl.value) || 0;

    const importe = precio * cantidad;               // sin IVA
    const iva = importe * TAX_RATE;                 // IVA por fila
    const total = importe + iva;                    // total por fila

    importeEl.value = importe.toFixed(DECIMALS);
    ivaEl.value = iva.toFixed(DECIMALS);
    subtotalEl.value = total.toFixed(DECIMALS);
}

/** Calcula los totales generales del presupuesto. */
function calcularTotales() {
    let subtotal = 0, ivaTotal = 0;
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;

    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => {
        const cantidad = parseFloat(tr.querySelector(".cantidad")?.value) || 0;
        const precio = parseFloat(tr.querySelector(".precio")?.value) || 0;
        const importe = cantidad * precio;
        const iva = ivaIncluido ? importe * TAX_RATE : 0;
        const total = importe + iva; 
        tr.querySelector(".importe").value = formatearNumeroAR(importe.toFixed(2));
        tr.querySelector(".iva").value = formatearNumeroAR(iva.toFixed(2));
        tr.querySelector(".subtotal").value = formatearNumeroAR(total.toFixed(2));
        
        subtotal += importe;
        ivaTotal += iva;
    });

    const total = subtotal + (ivaIncluido ? ivaTotal : 0);
    document.getElementById("subtotal").textContent = formatearNumeroAR(subtotal.toFixed(2));
    document.getElementById("iva").textContent = formatearNumeroAR(ivaIncluido ? ivaTotal.toFixed(2) : 0);
    document.getElementById("total").textContent = formatearNumeroAR(total.toFixed(2));
}


 

/* ===========================================
   MANEJO DE TABLA DE PRESTACIONES
   =========================================== */

/* Aca esta funcion agrega proporcionales en medicamento */
document.getElementById("btn-medicamentos").addEventListener("click", function() {
    const porcentaje = parseFloat(document.getElementById("med-prop").value) / 100; // 0.4, 0.5, etc.
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const ivaIncluido = document.getElementById("chek-iva")?.checked ?? true;
    // Función auxiliar para procesar un código base y crear/actualizar fila proporcional
    function procesarCodigoBase(codigoBase, codigoDestino, nombrePrestacion) {
        // Buscar fila existente (la proporcional)
        let filaExistente = Array.from(tbody.querySelectorAll("tr"))
            .find(f => f.querySelector(".codigo").value.trim() === codigoDestino);

        // Sumamos cantidades y precios proporcionales de todas las filas con codigoBase
        let totalCantidad = 0;
        let totalPrecio = 0;

        Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
            const codigo = fila.querySelector(".codigo").value.trim();
            if (codigo === codigoBase &&codigoDestino!='medquir') {
                const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
                const precioOriginal = parseFloat(fila.querySelector(".precio").value) || 0;
                totalCantidad += cantidad;
                totalPrecio += precioOriginal * porcentaje * cantidad;
            }
        });
        if(codigoDestino=='medquir'){
            Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
                const codigo = fila.querySelector(".codigo").value.trim(); 
                if (parseInt(codigo) <140000 || parseInt(codigo)>700000) {
                    const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 0;
                    const precioOriginal = parseFloat(fila.querySelector(".precio").value) || 0; 
                    totalPrecio += precioOriginal * porcentaje * cantidad; 
                }
            });
            totalCantidad=1;
        }

        if (totalCantidad === 0) return; // no hay filas base, nada que hacer

        const iva = ivaIncluido ? totalPrecio * TAX_RATE : 0;
        const subtotal = totalPrecio + iva;

        if (!filaExistente) {
            // Creamos nueva fila basada en la primera fila del codigoBase
            const filaBase = Array.from(tbody.querySelectorAll("tr"))
                .find(f => f.querySelector(".codigo").value.trim() === codigoBase);

            if (!filaBase) return; // seguridad por si no se encuentra

            const nuevaFila = filaBase.cloneNode(true);

            // Seteamos valores proporcionales
            nuevaFila.querySelector(".codigo").value = codigoDestino;
            nuevaFila.querySelector(".prestacion").value = nombrePrestacion;
            nuevaFila.querySelector(".cantidad").value = totalCantidad;
            nuevaFila.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS);
            nuevaFila.querySelector(".comentario").value = ""
            // Insertamos al final
            tbody.appendChild(nuevaFila);
        } else {
            // Actualizamos fila existente
            filaExistente.querySelector(".cantidad").value = totalCantidad;
            filaExistente.querySelector(".precio").value = (totalPrecio / totalCantidad).toFixed(DECIMALS);
        }
    }

    // --- Procesamos códigos fijos ---
    procesarCodigoBase("430101", "medint", "Medicamentos y descartables en Internado");
    procesarCodigoBase("400101", "meduti", "Medicamentos y descartables en UTI");

    // --- Nueva lógica para generar MEDQUIR ---
    Array.from(tbody.querySelectorAll("tr")).forEach(fila => {
        const codigo = fila.querySelector(".codigo").value.trim();

        // Si es un código numérico y cumple la condición (<140000 o >720000)
        if (!isNaN(codigo) && (parseInt(codigo) < 140000 || parseInt(codigo) > 720000)) {
            procesarCodigoBase(codigo, "medquir", "Medicamentos y descartables en Quirófano");
            
        }
    });

    // Recalculamos totales generales
    calcularTotales();
});





/** Crea una nueva fila en la tabla. */
function agregarFila() {
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    const template = tbody.querySelector("tr.fila-detalle");
    const fila = template.cloneNode(true);

    fila.querySelectorAll("input").forEach(el => {
        el.value = el.classList.contains("cantidad") ? 1 : "";
        if (el.classList.contains("precio")) el.value = (0).toFixed(DECIMALS);
    });

    tbody.appendChild(fila); 
}

/** Elimina fila (o limpia si es la última). */
function eliminarFila(tr) {
    const tbody = document.querySelector("#tabla-prestaciones tbody");
    if (tbody.querySelectorAll("tr").length > 1) {
        tr.remove();
    } else {
        tr.querySelectorAll("input").forEach(i => i.value = i.classList.contains("cantidad") ? 1 : "");
    }
    calcularTotales();
}


/* ===========================================
   EVENTOS GLOBALES
   =========================================== */

// Recalcular cuando cambian campos editables
document.addEventListener("input", e => {
    const tr = e.target.closest("#tabla-prestaciones tr");
    if (tr && ["precio", "cantidad", "codigo", "prestacion"].some(c => e.target.classList.contains(c))) {
        calcularTotales();
    }
});



// Cambio de tipo (gastos/especialista/todo)
document.getElementById("tabla-prestaciones").addEventListener("change", e => {
    if (!e.target.classList.contains("tipo")) return;
    const fila = e.target.closest("tr");
    const codigo = fila.querySelector(".codigo").value;
    const tipo = e.target.value;

    const url = "{% url 'presupuestos_app:get_tipo' codigo='__codigo__' %}"
        .replace("__codigo__", encodeURIComponent(codigo));

    fetch(`${url}?tipo=${tipo}`)
        .then(r => r.json())
        .then(data => { 
            const cantidad = parseFloat(fila.querySelector(".cantidad").value) || 1;
            const precio = parseFloat(data.precio) || 0; 

            fila.querySelector(".precio").value = precio.toFixed(2); 
            calcularTotales();
        })
        .catch(err => console.error("Error al traer tipo:", err));
});

// Botones agregar/eliminar fila
document.getElementById("agregar-fila").addEventListener("click", agregarFila);
document.addEventListener("click", e => {
    if (e.target.classList.contains("eliminar-fila")) eliminarFila(e.target.closest("tr"));
});

// Cambio de IVA incluido
document.getElementById("chek-iva").addEventListener("change", calcularTotales);

// Inicialización
/* Inicialización: recalcula en caso que haya valores precargados */
document.addEventListener("DOMContentLoaded", function(){
    document.querySelectorAll("#tabla-prestaciones tbody tr").forEach(tr => actualizarFila(tr));
    calcularTotales();
    document.getElementById("chek-iva").addEventListener("change", calcularTotales);
    window.history.pushState({}, "");
    window.addEventListener("popstate", () => {
        window.location.href = "{% url 'presupuestos_app:presupuestos' %}";
    });
});

/* ===========================================
   CONFIRMACIÓN DE GUARDADO
   =========================================== */

document.getElementById("btnGuardarPresupuesto").addEventListener("click", () => {
    const form = document.getElementById("form-presupuesto");

    // ejecuta la validación HTML5 normal
    if (!form.checkValidity()) {
        form.reportValidity();   // muestra los mensajes de error del navegador
        return;                  // cancela el envío si hay errores
    }
    new bootstrap.Modal(document.getElementById("modalConfirmacion")).show();
});

document.getElementById("btnConfirmarGuardar").addEventListener("click", () => {
    const modal = bootstrap.Modal.getInstance(document.getElementById("modalConfirmacion"));
    modal.hide();

    const form = document.getElementById("form-presupuesto");
    history.replaceState(null, "", "{% url 'presupuestos_app:detalle_presupuesto' presupuesto.id %}");

    form.submit();

    // 🧩 Previene volver atrás
    setTimeout(() => {
        history.replaceState(null, "", "{% url 'presupuestos_app:detalle_presupuesto' presupuesto.id %}");
        window.addEventListener("popstate", () => {
            window.location.replace("{% url 'presupuestos_app:presupuestos' %}");
        });
    }, 300);
});

/* ===========================================
   COMENTARIOS EN CADA FILA
   =========================================== */
let filaComentarioActual = null;

document.addEventListener("click", e => {
    // Si se hace clic en el ícono de comentario
    if (e.target.closest(".btn-comentario")) {
        filaComentarioActual = e.target.closest("tr");
        const comentarioGuardado = filaComentarioActual.querySelector(".comentario").value || "";
        document.getElementById("textoComentario").value = comentarioGuardado;
        const modal = new bootstrap.Modal(document.getElementById("modalComentario"));
        modal.show();
    }
});

document.getElementById("btnGuardarComentario").addEventListener("click", () => {
    const texto = document.getElementById("textoComentario").value.trim();
    if (filaComentarioActual) {
        // Guardar comentario en input oculto
        const inputHidden = filaComentarioActual.querySelector(".comentario");
        inputHidden.value = texto;

        // Cambiar color del ícono si hay comentario
        const btn = filaComentarioActual.querySelector(".btn-comentario");
        const icon = btn.querySelector("i");
        if (texto) {
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-warning");
            icon.classList.remove("fa-comment-dots");
            icon.classList.add("fa-comment");
        } else {
            btn.classList.remove("btn-warning");
            btn.classList.add("btn-outline-secondary");
            icon.classList.remove("fa-comment");
            icon.classList.add("fa-comment-dots");
        }
    }

    bootstrap.Modal.getInstance(document.getElementById("modalComentario")).hide();
});


 


</script>

{% endblock %}
